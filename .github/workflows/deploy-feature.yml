name: Deploy APEX Feature Branch

# This workflow runs ONLY on pushes to branches matching 'feature/**'
on:
  push:
    branches:
      - 'wc-**'
  # Allow manual runs for redeploying a feature branch
  workflow_dispatch:

jobs:
  deploy-feature-app:
    runs-on: ubuntu-latest
    
    # All feature branches will use the 'development' environment and its secrets
    environment:
      name: development
      
    steps:
      - name: Checkout Repository Code
        uses: actions/checkout@v4

      - name: Setup SQLcl
        run: |
          wget https://download.oracle.com/otn_software/java/sqldeveloper/sqlcl-latest.zip
          unzip -o sqlcl-latest.zip
          echo "$(pwd)/sqlcl/bin" >> $GITHUB_PATH

      - name: Deploy to APEX and Set Alias
        env:
          GITHUB_TOKEN: ${{ secrets.TOK }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          ENVIRONMENT: ${{ github.ref_name }}
          DB_URL: ${{ vars.DB_URL }}
          DB_USER: ${{ vars.DB_USER }}
          APP_ID: ${{ vars.APP_ID }}
          WKSPACE: ${{ vars.WKSPACE }}
          SCHEMA: ${{ vars.SCHEMA }}
          APP_EXPORT: ${{ vars.APP_EXPORT }}

        run: |

          # 1. Sanitize the branch name to create a valid and clean alias
          # e.g., 'feature/new-user-auth' becomes 'FEAT-NEW-USER-AUTH'
          BRANCH_SLUG=$(echo "${{ github.ref_name }}" | sed 's/\//-/g' | tr '[:lower:]' '[:upper:]')
          export APEX_APP_ALIAS="F${BRANCH_SLUG}" # The final alias, e.g., FFEAT-NEW-USER-AUTH
          
          echo " Branch: ${{ github.ref_name }}"
          echo " Generated APEX Alias: $APEX_APP_ALIAS"
          
          echo "--- Generated app deploy SQL Script ---"
          # Reads the template and outputs a processed file
          envsubst < deploy_apex_app.sql.template > deploy_apex_app.sql
          cat deploy_apex_app.sql
          echo "--------------------------"
          
          # 2. Deploy the application using the standard export file
          echo "Deploying f120.sql..."
          echo "${{ vars.ATP_WALLET_DEV }}" | base64 --decode > Wallet_DEVENV.zip
          sql  -cloudconfig  Wallet_DEVENV.zip $DB_USER/$DB_PASSWORD@$DB_URL @deploy_apex_app.sql


